#####################################################
# azure build Docker steps (template)
# (c)2021 IDNMedia
#####################################################
parameters:
  - name: dockerCommand
    type: string
    default: 'build'
  - name: dockerRepository
    type: string
    default: 'idnmedia/go/livestream'
  - name: dockerfile
    type: string
    default: 'Dockerfile'
    
  - name: containerRegistry
    type: string
    default: 'mbakmia-registry'
  - name: tag
    type: string
    default: 'development'
  - name: tagSourceBranch
    type: string
    default: $(Build.SourceBranchName)

  - name: displayName
    type: string
    default: 'Build Docker Image'    

steps:
    - bash: |
        set -ex
        tag=$(Build.SourceBranchName)
        echo "##vso[task.setvariable variable=tag;]${{parameters.tag}}"
        echo $tag
      env:
        tag: ${{ parameters.tag }}
      displayName: 'Set Tag to $(Build.SourceBranchName)'

    - task: Docker@2
      displayName: ${{ parameters.displayName }}
      inputs:
        containerRegistry: ${{ parameters.containerRegistry }}
        repository: ${{ parameters.dockerRepository }}
        command: ${{ parameters.dockerCommand }}
        Dockerfile: ${{ parameters.dockerfile }}
        tags: |
          ${{ parameters.tag }}
          ${{ parameters.tagSourceBranch }}

